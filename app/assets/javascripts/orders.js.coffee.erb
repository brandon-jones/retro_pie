# Place all the behaviors and hooks related to the matching controller here.
# All this logic will automatically be available in application.js.
# You can use CoffeeScript in this file: http://coffeescript.org/
$ ->
  $("#delivery_type").on "change", scrapeData

  $(".price-changer").on "change", updateQuantity

  $('.order-change').on "change", toggleChangedFlag

  $('#save_order_edits').on "click", saveOrderEdits

  $('.change_sort').on "click", changeSort

  $('.order-details').on "click", showOrderDetails

showOrderDetails = (e)->
  e.stopPropagation()
  e.preventDefault()
  details_id = "#"+this.getAttribute('data')
  if $(details_id)[0].style.display == 'none'
    $(details_id).show(200,'linear')
  else
    $(details_id).hide(200,'linear')
  
changeSort = (event) ->
  event.stopPropagation()
  event.preventDefault()
  $('#save_order_edits').addClass('hidden')
  $.get '/orders',
      sort_by: this.getAttribute('data')
      sort_order: $('#sort_order').val()
      table_only: true
      (data) -> 
        $('#order_table').html(data)
        $('.change_sort').on "click", changeSort
        $('.order-details').on "click", showOrderDetails
        $('.order-change').on "change", toggleChangedFlag

scrapeData = (event) ->
  if $("#delivery_type").val() =='delivery'
    $('#shipping').show(300,'linear')
    $('#shipping_price').val("$<%= $shipping %>")
  else
    $('#shipping_price').val('$0')
    $('#shipping').hide(300,'linear')
  return

updateQuantity = (event) ->
  total_price = <%= $base_price %>
  $(".item-row").each (element) ->
    if isRowActive(this)
      quantity = getQuantity(this)
      price = getPrice(this, quantity)
      total_price =  parseInt(total_price) + parseInt(price)
  total_price = total_price + parseInt($('#shipping_price').val().replace('$',''))
  $('.total').text("$"+total_price)
  $('#clean-total').val(total_price)


getPrice = (row, quantity) ->
  if row.children[3].innerText == "included"
    if quantity > 1
      return row.children[3].children[0].value
    else
      return 0
  else
    return quantity * row.children[3].children[0].value

getQuantity = (row) ->
  row.children[4].children[0].value

isRowActive = (row) ->
  if row.children[0].children[0].checked == true
    return true
  else
    return false

toggleChangedFlag = () ->
  $('#order-index').addClass('unsaved-changes')
  $(this).addClass('unsaved-changes-background')
  if $('#save_order_edits').hasClass('hidden')
    $('#save_order_edits').removeClass('hidden')

saveOrderEdits = () ->
  changedRows = []
  $('.unsaved-changes-background').each (element) ->
    $(this).removeClass('unsaved-changes-background')
    $(this).closest(".order-row").addClass('flash-save')
    delay 1, fadeOutGreen
    parentElement = this.parentElement.parentElement
    changedRows.push([parentElement.getElementsByClassName('order_id')[0].innerHTML, parentElement.getElementsByClassName('status_id')[0].value])
  $('#save_order_edits').addClass('hidden')
  $('#order-index').removeClass('unsaved-changes')
  if changedRows.length > 0
    $.post '/orders/update',
      changed_orders: changedRows.toString()
      (data) -> 
      
fadeOutGreen = () ->
  $('.flash-save').each (element) ->
    $(this).removeClass('flash-save')
    $(this).addClass('fade-out')
    delay 5000, remove_updated_classes

remove_updated_classes = () ->
  console.log('remove_updated_classes')
  $('.fade-out').each  (element) ->
    $(this).removeClass('fade-out')

delay = (ms, func) -> setTimeout func, ms
